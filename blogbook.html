<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog Feed to Book - Posts Output</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body class="blogbook">
    <main id="main" class="main-book">
      <h2>Blog Book Placeholder</h2>
      <p>
        This page is used by "Blogger Blog Feed to HTML Book" page to
        dynamically load blog books. These contents are a placeholder while the
        blog book is getting loaded.
      </p>
      <p>
        Note that small blog books may take a second or few seconds to load.
        Larger blog books may take longer to load.
      </p>
      <p>
        Note that this window is supposed to be automatically opened by "Blogger
        Feed to HTML Book". If you have come to this page directly or you have
        refreshed the page, then the blog book will not be created here and you
        may please close the window.
      </p>
    </main>
    <script src="helpers.js"></script>
    <script>
      function isExternalLink(linkhref) {
        const docURL = document.URL;
        let docURLBase = docURL;
        const hashCharIndex = docURL.indexOf("#");
        if (hashCharIndex === 0) {
          console.log("Unexpected positon of # char as 0 in document URL");
          // throwing an error may be too drastic. So just return true as external link
          // will result in new tab/window without current tab/window losing dynamic contents
          return true;
        } else if (hashCharIndex > 0) {
          docURLBase = docURL.substring(0, hashCharIndex);
        }
        if (linkhref.includes(docURLBase)) {
          return false;
        } else {
          return true;
        }
      }
      // External links should be opened in new tab/window as otherwise dynamic HTML
      // of this tab/window will be lost.
      // But internal links should be opened in this tab/window.
      document.body.addEventListener("click", function (e) {
        if (e.target && e.target.nodeName == "A") {
          if (isExternalLink(e.target.href)) {
            e.target.target = "_blank";
          }
        } else if (e.target && e.target.nodeName == "IMG") {
          if (isExternalLink(e.target.currentSrc)) {
            e.preventDefault(); //this works and so we can open window in new tab
            window.open(e.target.currentSrc); //works!
            // Appending "?target=_blank" to e.target.currentSrc did not work as
            // assigning to e.target.currentSrc is not changing its value!
          }
        }
      });

      function handleSaveClick() {
        let bodyInnerHTMLWithoutSaveBtn = document.body.innerHTML;
        const firstButtonPos = document.body.innerHTML.indexOf("<button");
        if (firstButtonPos > 0) {
          const firsth1StartPos = document.body.innerHTML.indexOf("<h1>");
          if (firsth1StartPos >= 0) {
            bodyInnerHTMLWithoutSaveBtn = document.body.innerHTML.substring(
              0,
              firstButtonPos
            );
            bodyInnerHTMLWithoutSaveBtn +=
              document.body.innerHTML.substring(firsth1StartPos);
          }
        }
        const bookHTML =
          "<html><head>" +
          `<style> 
          .blogbook {
            margin-left: 20px;
            margin-right: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 760px;
          }
          .main-book {
            max-width: 1200px;
          }
          </style>` +
          '</head><body class="blogbook">' +
          bodyInnerHTMLWithoutSaveBtn +
          // Below split is to workaround Live Server VSCode extension tripping up and inserting its JavaScript
          // code just after end html tag in string literal thereby making handleSaveClick() an unrecognized
          // (or something like that) function.
          "</bo" +
          "dy>" +
          "</ht" +
          "ml>";
        writeBook(bookHTML);
      }
    </script>
  </body>
</html>
